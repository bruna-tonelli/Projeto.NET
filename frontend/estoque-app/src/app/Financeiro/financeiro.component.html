<title>Financeiro</title> <base href="/financeiro">
<div class="page-container" [class.page-container-dark] = "modoEscuroAtivo">
  <header class="page-header" [class.page-header-dark] = "modoEscuroAtivo">
    <div class="search-container" [class.search-container-dark] = "modoEscuroAtivo">
      <div class="search-box" [class.search-box-dark] = "modoEscuroAtivo">
        <i class="fas fa-search search-icon"></i>
        <input type="text" placeholder="Pesquise por ID, produto ou tipo" [(ngModel)]="termoBusca" (input)="buscar()" (keyup.enter)="pesquisarPorBotao()">
        <button *ngIf="pesquisaRealizada || termoBusca" class="btn-clear-inline"  (click)="limparPesquisa()" title="Limpar pesquisa">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <button class="btn btn-search" [class.btn-search-dark] = "modoEscuroAtivo" (click)="pesquisarPorBotao()" title="Pesquisar">
        <i class="fas fa-search"></i>
      </button>
       <button class="btn btn-filtro" [class.btn-filtro-dark] = "modoEscuroAtivo" (click)="abrirModalFiltrar()">
        <i class="fa-solid fa-sliders"></i>
      </button>
    </div>
  </header>

  <section class="page-content">
    <div *ngIf="isLoading" class="status-message">Carregando dados financeiros...</div>

    <ng-container *ngIf="!isLoading">
      <div class="saldo-empresarial-container" [class.saldo-empresarial-container-dark] = "modoEscuroAtivo">
        <div class="saldo-card" [class.saldo-card-dark] = "modoEscuroAtivo">
          <div class="saldo-header" [class.saldo-header-dark] = "modoEscuroAtivo">
            <h2 class="saldo-title" [class.saldo-title-dark] = "modoEscuroAtivo">Saldo Operacional</h2>
            <div class="saldo-icon" [class.saldo-icon-dark] = "modoEscuroAtivo" (click)="toggleGrafico()" style="cursor: pointer;" title="Clique para mostrar/esconder gráfico">
              <i class="fas fa-chart-line" [class.chart-line-dark] = "modoEscuroAtivo"></i>
            </div>
          </div>
          <div class="saldo-valor" [class.valor-positivo]="caixaDaEmpresa >= 0" [class.valor-negativo]="caixaDaEmpresa < 0">
            {{ caixaDaEmpresa | currency:'BRL':'symbol':'1.2-2' }}
          </div>
          <div class="saldo-info" [class.saldo-info-dark]  = "modoEscuroAtivo">
            <span class="saldo-descricao" [class.saldo-descricao-dark] = "modoEscuroAtivo">Fluxo de caixa consolidado</span>
            <span class="saldo-status" [class.saldo-status-dark] = "modoEscuroAtivo" [class.status-positivo]="caixaDaEmpresa >= 0" [class.status-negativo]="caixaDaEmpresa < 0">
              {{ caixaDaEmpresa >= 0 ? 'Positivo' : 'Negativo' }}
            </span>
          </div>
        </div>
      </div>
      <div class="grafico-container" [class.grafico-container-dark] = "modoEscuroAtivo" *ngIf="mostrarGrafico">
        <h3 class="grafico-titulo" [class.grafico-titulo-dark] = "modoEscuroAtivo">Resumo de entradas e saídas de produtos por mês</h3>
  
        <div *ngIf="!dadosGrafico" class="no-data-message" style="text-align: center; padding: 20px;">
          <p>Nenhum dado disponível para exibir o gráfico.</p>
          <p>Adicione movimentações com preços de venda para visualizar o gráfico.</p>
        </div>
  
        <div *ngIf="dadosGrafico" style="height: 400px; width: 100%;">
          <canvas 
            baseChart 
            [data]="barChartData" 
            [options]="barChartOptions" 
            [type]="barChartType">
          </canvas>
          </div>
        </div>

      <div *ngIf="pesquisaRealizada && termoBusca && movimentacoesExibidas.length > 0" class="search-result-message">
        Resultados da pesquisa por "{{ termoBusca }}": {{ movimentacoesExibidas.length }} movimentação(ões) encontrada(s)
      </div>
      <div *ngIf="pesquisaRealizada && termoBusca && movimentacoesExibidas.length === 0" class="search-result-message no-results">
        Nenhuma movimentação encontrada para "{{ termoBusca }}"
      </div>
      <div *ngIf="movimentacoesExibidas.length === 0 && !pesquisaRealizada" class="status-message">
        Nenhuma movimentação registrada.
      </div>
      
      <div class="item-list" [class.item-list-dark] = "modoEscuroAtivo">
        <div class="item-card" [class.item-card-dark] = "modoEscuroAtivo" *ngFor="let movimentacao of movimentacoesExibidas">
          <div class="card-section id-section" [class.card-section-dark] = "modoEscuroAtivo" >
            <span class="card-label" [class.card-label-dark] = "modoEscuroAtivo">ID</span>
            <span class="card-value" [class.card-value-dark] = "modoEscuroAtivo">{{ movimentacao.id }}</span>
          </div>
          <div class="card-section name-section" [class.card-section-dark] = "modoEscuroAtivo">
            <span class="card-label" [class.card-label-dark] = "modoEscuroAtivo">Produto</span>
            <span class="card-value" [class.card-value-dark] = "modoEscuroAtivo">{{ movimentacao.produtoNome }}</span>
          </div>
          <div class="card-section date-section" [class.card-section-dark] = "modoEscuroAtivo" *ngIf="movimentacao.dataMovimentacao">
            <span class="card-label" [class.card-label-dark] = "modoEscuroAtivo">Data</span>
            <span class="card-value" [class.card-value-dark] = "modoEscuroAtivo">{{ movimentacao.dataMovimentacao | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="card-section quantity-section" [class.card-section-dark] = "modoEscuroAtivo" >
            <span class="card-label" [class.card-label-dark] = "modoEscuroAtivo">Quantidade</span>
            <span class="card-value" [class.card-value-dark] = "modoEscuroAtivo">{{ movimentacao.quantidade }}</span>
          </div>
          <div class="card-section type-section" [class.card-section-dark] = "modoEscuroAtivo" >
            <span class="card-label" [class.card-label-dark] = "modoEscuroAtivo">Tipo</span>
            <span class="card-value" [class.card-value-dark] = "modoEscuroAtivo">{{ movimentacao.tipo }}</span>
          </div>
          <div class="card-section value-section" [class.card-section-dark] = "modoEscuroAtivo" >
            <span class="card-label" [class.card-label-dark] = "modoEscuroAtivo">Valor Total</span>
            <span class="card-value" [class.card-value-dark] = "modoEscuroAtivo" 
                  [style.color]="movimentacao.tipo === 'ENTRADA' ? '#dc3545' : '#28a745'">
              {{ (movimentacao.tipo === 'ENTRADA' ? '-' : '+') + (movimentacao.valorTotal | currency:'BRL':'symbol':'1.2-2') }}
            </span>
          </div>
        </div>
      </div>
    </ng-container>
  </section>

     <!-- Modal de filtro -->
<div class="modal-filtro" *ngIf="modalFiltroAberto">
  <div class="filtro-container" [class.filtro-container-dark]  = "modoEscuroAtivo">
    <div class="filtro-header" [class.filtro-header-dark]  = "modoEscuroAtivo">
      <h2>Filtros</h2>
      <button class="close-btn" [class.close-btn-dark]  = "modoEscuroAtivo" (click)="fecharModalFiltrar()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="filtro-body" [class.filtro-body-dark]  = "modoEscuroAtivo">
      <!-- Filtro Tipo -->
      <label>Tipo</label>
      <select [(ngModel)]="filtros.tipo">
        <option value="">Todos</option>
        <option value="ENTRADA">Entrada</option>
        <option value="SAIDA">Saída</option>
      </select>

      <!-- Filtro por Data -->
      <div class="data-range" [class.data-range-dark] = "modoEscuroAtivo">
        <label>Data Inicial</label>
        <input type="date" [(ngModel)]="filtros.dataInicial" />

        <label>Data Final</label>
        <input type="date" [(ngModel)]="filtros.dataFinal" />
      </div>
    </div>

    <div class="filtro-footer">
      <button class="limpar-btn" [class.limpar-btn-dark] = "modoEscuroAtivo" (click)="limparFiltros()">Limpar Filtros</button>
      <button class="aplicar-btn" [class.aplicar-btn-dark] = "modoEscuroAtivo" (click)="aplicarFiltro()">Aplicar</button>
    </div>
  </div>
</div>