<div class="page-container">
  <header class="page-header">
    <div class="search-container">
      <div class="search-box search-box-small">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          placeholder="Pesquise por nome ou por Id"
          [(ngModel)]="termoBusca"
          (input)="buscar()"
          (keyup.enter)="pesquisarPorBotao()">
        <button *ngIf="pesquisaRealizada || termoBusca" class="btn-clear-inline" (click)="limparPesquisa()" title="Limpar pesquisa">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <button class="btn btn-search" (click)="pesquisarPorBotao()" title="Pesquisar">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <div class="actions">
      <button class="btn btn-primary" (click)="abrirModalAdicionar()">
        <i class="fas fa-plus"></i> ADICIONAR MOVIMENTAÇÃO
      </button>
    </div>
  </header>

  <section class="page-content">
    <div *ngIf="isLoading" class="status-message">Carregando...</div>
    <ng-container *ngIf="!isLoading">
      <div *ngIf="pesquisaRealizada && termoBusca && movimentacoesExibidas.length > 0" class="search-result-message">
        Resultados da pesquisa por "{{ termoBusca }}": {{ movimentacoesExibidas.length }} movimenação(s) encontrada(s)
      </div>
      <div *ngIf="pesquisaRealizada && termoBusca && movimentacoesExibidas.length === 0" class="search-result-message no-results">
        Nenhuma movimentação encontrada para "{{ termoBusca }}"
      </div>
      <div *ngIf="movimentacoesExibidas.length === 0 && !pesquisaRealizada" class="status-message">Nenhum produto encontrado.</div>
      <div class="item-list">
        <div 
          class="item-card" 
          *ngFor="let movimentacao of movimentacoesExibidas"
          (click)="selecionarItem(movimentacao)"
          [ngClass]="{'item-selecionado': movimentacao.id === itemSelecionado?.id}">
          <div class="card-section id-section">
            <span class="card-label">ID</span>
            <span class="card-value">{{ movimentacao.id }}</span>
          </div>
          <div class="card-section name-section">
            <span class="card-label">TIPO</span>
            <span class="card-value">{{ movimentacao.tipo }}</span>
          </div>
          <div class="card-section quantity-section">
            <span class="card-label">QUANTIDADE</span>
            <span class="card-value">{{ movimentacao.quantidade | number }}</span>
          </div>
          <div class="card-section product-section">
            <span class="card-label">PRODUTO</span>
            <span class="card-value">{{ movimentacao.produtoNome || 'Produto não informado' }}</span>
          </div>
          <div class="card-section user-section">
            <span class="card-label">FUNCIONÁRIO</span>
            <span class="card-value">{{ movimentacao.funcionarioNome || 'Funcionário não informado' }}</span>
          </div>
          <div class="card-section date-section" *ngIf="movimentacao.dataMovimentacao">
            <span class="card-label">DATA</span>
            <span class="card-value">{{ movimentacao.dataMovimentacao | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="card-actions">
            <button 
              class="btn btn-edit" 
              type="button"
              (click)="editarMovimentacao(movimentacao); $event.stopPropagation()"
              title="Editar movimentação">
              <i class="fas fa-edit"></i>
            </button>
            <button 
              class="btn btn-delete" 
              type="button"
              (click)="excluirMovimentacao(movimentacao.id); $event.stopPropagation()"
              title="Excluir movimentação">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          
        </div>
      </div>
    </ng-container>
  </section>

  <!-- Modal de Adicionar Produto -->
  <div class="modal-backdrop" *ngIf="modalAberto">
    <div class="modal-produto">
      <h2>Nova Movimentação</h2>
      <form (ngSubmit)="adicionarMovimentacao()" #formMovimentacao="ngForm">
        <label for="tipo">Tipo de Movimentação</label>
        <select id="tipo" [(ngModel)]="novaMovimentacao.tipo" name="tipo" required>
          <option value="">Selecione o tipo</option>
          <option value="ENTRADA">ENTRADA</option>
          <option value="SAÍDA">SAÍDA</option>
        </select>

        <label for="produto">Produto</label>
        <select id="produto" [(ngModel)]="novaMovimentacao.produtoId" name="produtoId" required>
          <option value="">Selecione o produto</option>
          <option *ngFor="let produto of produtos" [value]="produto.id">
            {{ produto.nome }} (Qtd: {{ produto.quantidade }})
          </option>
        </select>

        <label for="funcionario">Funcionário Responsável</label>
        <input 
          id="funcionario" 
          type="text" 
          [value]="getFuncionarioLogadoNome()" 
          readonly 
          class="input-readonly"
          title="Este campo é preenchido automaticamente com o usuário logado">
        <input type="hidden" [(ngModel)]="novaMovimentacao.funcionarioId" name="funcionarioId">

        <label for="quantidade">Quantidade</label>
        <input id="quantidade" type="number" placeholder="Ex. 10" [(ngModel)]="novaMovimentacao.quantidade" name="quantidade" required min="1">

        <label for="observacoes">Observações (opcional)</label>
        <textarea id="observacoes" placeholder="Observações sobre a movimentação..." [(ngModel)]="novaMovimentacao.observacoes" name="observacoes" rows="3"></textarea>

        <button class="btn btn-primary" type="submit" [disabled]="formMovimentacao.invalid">Salvar</button>
        <button class="btn btn-secondary" type="button" (click)="fecharModal()">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Modal de Editar Movimentação -->
  <div class="modal-backdrop" *ngIf="modalEditarAberto">
    <div class="modal-produto">
      <h2>Editar Movimentação</h2>
      <form (ngSubmit)="salvarEdicao()" #formEdicao="ngForm" *ngIf="movimentacaoEditando">
        <label for="tipoEdit">Tipo de Movimentação</label>
        <select id="tipoEdit" [(ngModel)]="movimentacaoEditando.tipo" name="tipo" required>
          <option value="">Selecione o tipo</option>
          <option value="ENTRADA">ENTRADA</option>
          <option value="SAÍDA">SAÍDA</option>
        </select>

        <label for="produtoEdit">Produto</label>
        <select id="produtoEdit" [(ngModel)]="movimentacaoEditando.produtoId" name="produtoId" required>
          <option value="">Selecione o produto</option>
          <option *ngFor="let produto of produtos" [value]="produto.id">
            {{ produto.nome }} (Qtd: {{ produto.quantidade }})
          </option>
        </select>

        <label for="funcionarioEdit">Funcionário Responsável</label>
        <input 
          id="funcionarioEdit" 
          type="text" 
          [value]="getFuncionarioLogadoNome()" 
          readonly 
          class="input-readonly"
          title="Este campo não pode ser editado">
        <input type="hidden" [(ngModel)]="movimentacaoEditando.funcionarioId" name="funcionarioId">

        <label for="quantidadeEdit">Quantidade</label>
        <input id="quantidadeEdit" type="number" placeholder="Ex. 10" [(ngModel)]="movimentacaoEditando.quantidade" name="quantidade" required min="1">

        <label for="observacoesEdit">Observações (opcional)</label>
        <textarea id="observacoesEdit" placeholder="Observações sobre a movimentação..." [(ngModel)]="movimentacaoEditando.observacoes" name="observacoes" rows="3"></textarea>

        <button class="btn btn-primary" type="submit" [disabled]="formEdicao.invalid">Salvar Alterações</button>
        <button class="btn btn-secondary" type="button" (click)="fecharModalEdicao()">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Modal de Confirmação de Exclusão -->
  <div class="modal-backdrop" *ngIf="modalConfirmacaoAberto">
    <div class="modal-confirmacao">
      <div class="modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3>Confirmar Exclusão</h3>
      <p>
        Tem certeza que deseja remover a movimentação 
        <strong>{{ movimentacaoParaRemover?.tipo }}</strong> do produto
        <strong>{{ movimentacaoParaRemover?.produtoNome }}</strong>?
      </p>
      <p class="warning-text">Esta ação não pode ser desfeita.</p>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" type="button" (click)="cancelarRemocao()">
          Cancelar
        </button>
        <button class="btn btn-danger" type="button" (click)="confirmarRemocaoFinal()">
          <i class="fas fa-trash"></i>
          Remover
        </button>
      </div>
    </div>
  </div>

 